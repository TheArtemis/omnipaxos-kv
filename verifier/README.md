# Linearizability Verifier

A tool for checking the linearizability of distributed key-value store operations using [Porcupine](https://github.com/anishathalye/porcupine).

## Overview

This verifier checks whether a history of operations from your distributed system is linearizable. It takes operation history JSON files (generated by clients with the `correctness-check` feature) and verifies that all operations can be ordered in a way that respects both:
1. **Real-time ordering**: If operation A finishes before B starts, A must come before B
2. **Sequential correctness**: The operations produce the correct outputs according to the KV store specification

## Prerequisites

- Go 1.16 or later
- Operation history JSON files from your clients

## Building

```bash
cd verifier
go build -o verifier ./cmd/verifier
```

Or run directly without building:
```bash
go run ./cmd/verifier
```

## Usage

### Basic Usage

**Check a single history file:**
```bash
go run ./cmd/verifier ./examples/history-1.json
```

**Check multiple history files (automatically merged):**
```bash
go run ./cmd/verifier ./examples/history-1.json ./examples/history-2.json
```

**With web server (opens visualization in browser):**
```bash
go run ./cmd/verifier --serve ./examples/history-1.json ./examples/history-2.json
```

**Custom port:**
```bash
go run ./cmd/verifier --serve --port 3000 ./examples/history-1.json
```

### Command-Line Flags

- `--serve`: Start a local web server to view the visualization (default: false)
- `--port <number>`: Port for the web server (default: 8080)

### Examples

**1. Check a single client's history:**
```bash
cd verifier
go run ./cmd/verifier ./examples/history-1.json
```

**2. Check multiple clients (merged automatically):**
```bash
go run ./cmd/verifier ./examples/history-*.json
```

**3. View visualization in browser:**
```bash
go run ./cmd/verifier --serve ./examples/history-1.json ./examples/history-2.json
# Then open http://localhost:8080 in your browser
```

**4. Full workflow from docker-compose:**
```bash
# 1. Run your system with correctness checking
cd build_scripts
docker compose -f docker-compose.correctness.yml build
docker compose -f docker-compose.correctness.yml up

# 2. After it completes, check the histories
cd ../verifier
go run ./cmd/verifier --serve ./examples/history-*.json
```

## Understanding the Output

### Linearizable History
```
✓ History is linearizable
  Total operations: 122
  Max partial linearization length: 122
```
✅ **All operations are linearizable** - your system is correct!

### Non-Linearizable History
```
✗ History is NOT linearizable
  Total operations: 61
  Max partial linearization length: 3 (out of 61)
  Check result: Illegal
```
❌ **Linearizability violation detected** - only 3 out of 61 operations can be ordered correctly. This indicates a bug in your system.

### Output Files

- **`merged-history.json`**: Created when multiple files are provided (contains all operations merged and sorted)
- **`<history-name>.html`**: Visualization file (always generated) - open in browser to see detailed analysis

## Visualization

The HTML visualization shows:
- **Green lines**: Operations that can be linearized
- **Red/gray lines**: Operations that violate linearizability
- **Partial linearizations**: Longest valid sequences found
- **Illegal points**: Operations that can't be placed in any valid ordering

Hover over operations to see details, click to select and inspect specific operations.

## History File Format

The verifier expects JSON files with the following format:

```json
[
  {
    "client_id": 1,
    "input": {
      "type": "Put",
      "key": "x",
      "value": "1"
    },
    "call": 1000000000,
    "output": {
      "status": "ok"
    },
    "return_time": 1000001000
  },
  {
    "client_id": 1,
    "input": {
      "type": "Get",
      "key": "x"
    },
    "call": 1000002000,
    "output": {
      "status": "ok",
      "value": "1"
    },
    "return_time": 1000003000
  }
]
```

**Fields:**
- `client_id`: Unique identifier for the client
- `input`: Operation input with `type` ("Put", "Get", "Delete"), `key`, and optionally `value`
- `call`: Timestamp (nanoseconds) when operation was invoked
- `output`: Operation output with `status` ("ok") and optionally `value`
- `return_time`: Timestamp (nanoseconds) when operation completed

## Testing the Verifier

Test files with intentional violations are included:

```bash
# These should show violations
go run ./cmd/verifier ./examples/test-violation-1.json ./examples/test-violation-2.json
```

Expected output: `✗ History is NOT linearizable` with low max partial length.

## Troubleshooting

**"package .: no Go files" or "undefined" errors:**
- Run `go run ./cmd/verifier` (not `go run .` or `go run main.go`)
- The verifier is split into a `cmd` entrypoint and internal packages

**Port already in use:**
- Use `--port` flag to specify a different port
- Or stop the existing server

**No operations found:**
- Check that your history JSON files are not empty
- Verify the JSON format is correct
- Ensure clients completed their operations

**All operations show as non-linearizable:**
- Check that timestamps are absolute (not relative to client start)
- Verify sync time is set correctly in your client code
- Ensure all clients use the same time reference

## Architecture

The verifier is organized into packages:

- **`cmd/verifier/main.go`**: Entry point, flag parsing, orchestration
- **`internal/verifier/types.go`**: Data structures (Operation, HistoryResult)
- **`internal/verifier/model.go`**: Porcupine model definition for KV store
- **`internal/verifier/history.go`**: History loading, merging, conversion
- **`internal/verifier/checker.go`**: Linearizability checking logic
- **`internal/verifier/server.go`**: HTTP server for visualization

## References

- [Porcupine GitHub](https://github.com/anishathalye/porcupine)
- [Linearizability Testing Paper](http://www.cs.ox.ac.uk/people/gavin.lowe/LinearizabiltyTesting/paper.pdf)
